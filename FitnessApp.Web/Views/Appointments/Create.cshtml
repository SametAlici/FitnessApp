@model FitnessApp.Web.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">üìÖ Yeni Randevu Olu≈ütur</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create">
                        <div asp-validation-summary="All" class="text-danger"></div>

                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">Randevu Tarihi</label>
                            <input type="date" name="selectedDate" class="form-control" required />
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">Randevu Saati</label>
                            <select name="selectedHour" class="form-select" required>
                                <option value="">-- Saat Se√ßiniz --</option>
                                @for (int i = 7; i <= 22; i++)
                                {
                                    <option value="@i">@i:00</option>
                                }
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="ServiceId" class="form-label fw-bold">Hizmet/Ders Se√ßiniz</label>
                            <select asp-for="ServiceId" class ="form-select" asp-items="ViewBag.ServiceId">
                                <option value="">-- Bir Hizmet Se√ßin --</option>
                            </select>
                        </div>

                        <div class="alert alert-success text-center" id="priceAlert" style="display:none;">
                            <strong>Tahmini √úcret:</strong> <span id="priceDisplay" class="fs-4 fw-bold">0</span> ‚Ç∫
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="TrainerId" class="form-label fw-bold">Antren√∂r Se√ßiniz</label>
                            <select asp-for="TrainerId" class ="form-select" disabled>
                                <option value="">-- √ñnce Hizmet Se√ßiniz --</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <input type="submit" value="Randevuyu Onayla ‚úÖ" class="btn btn-success btn-lg" />
                            <a asp-action="Index" class="btn btn-secondary">Listeye D√∂n</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $(document).ready(function () {
            var allTrainers = @Html.Raw(ViewBag.TrainerData ?? "[]");
            var allServices = @Html.Raw(ViewBag.ServiceData ?? "[]"); // Fiyat verisi
            
            var $serviceSelect = $("#ServiceId");
            var $trainerSelect = $("#TrainerId");
            var $priceDisplay = $("#priceDisplay");
            var $priceAlert = $("#priceAlert");

            $serviceSelect.change(function () {
                var selectedServiceId = parseInt($(this).val());
                $trainerSelect.empty();
                
                if (selectedServiceId) {
                    // 1. Fiyatƒ± Bul ve G√∂ster
                    var serviceInfo = allServices.find(s => s.id === selectedServiceId);
                    if(serviceInfo) {
                        $priceDisplay.text(serviceInfo.price);
                        $priceAlert.fadeIn();
                    }

                    // 2. Antren√∂rleri Filtrele
                    var count = 0;
                    $trainerSelect.append('<option value="">-- Bir Antren√∂r Se√ßin --</option>');

                    $.each(allTrainers, function (index, trainer) {
                        if (trainer.serviceIds.includes(selectedServiceId)) {
                            $trainerSelect.append('<option value="' + trainer.id + '">' + trainer.fullName + '</option>');
                            count++;
                        }
                    });

                    if(count > 0) {
                         $trainerSelect.prop("disabled", false);
                    } else {
                         $trainerSelect.append('<option value="">‚ùå Bu hizmeti veren hoca bulunamadƒ±</option>');
                         $trainerSelect.prop("disabled", true);
                    }
                } else {
                    $trainerSelect.prop("disabled", true);
                    $trainerSelect.append('<option value="">-- √ñnce Hizmet Se√ßiniz --</option>');
                    $priceAlert.hide(); // Se√ßim yoksa fiyatƒ± gizle
                }
            });
        });
    </script>
}